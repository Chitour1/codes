<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر الأكواد بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

    <style>
        html { height: 100%; }
        body { font-family: 'Cairo', sans-serif; height: 100%; overflow: hidden; }
        .main-container { display: flex; flex-direction: column; height: 100%; }
        .CodeMirror {
            border: 1px solid #4b5563; border-radius: 0.5rem; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0; height: auto;
            font-family: 'Fira Code', 'Courier New', monospace; font-size: 14px;
        }
        .CodeMirror-scroll { background-color: #1f2937; }
        .editor-container { flex-grow: 1; position: relative; }
        .action-button:disabled { cursor: not-allowed; background-color: #374151; }
        .api-key-wrapper { position: relative; }
        #apiKeyInput { padding-left: 2.75rem; }
        #verifyApiKeyButton {
            position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%);
            color: #9ca3af; background: transparent; border: none; cursor: pointer; padding: 0.25rem;
        }
        #verifyApiKeyButton:hover { color: #e5e7eb; }
        .label-with-action { display: flex; justify-content: space-between; align-items: center; }
        .paste-button { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; }
        .paste-button:hover { color: #e5e7eb; }
        /* Custom radio button styles */
        .radio-label input:checked + .radio-button {
            background-color: #0891b2; /* cyan-600 */
            border-color: #0e7490; /* cyan-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="main-container max-w-7xl mx-auto space-y-4 p-4 sm:p-6 md:p-8 w-full">
        <!-- Header -->
        <header class="text-center flex-shrink-0">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">محرر الأكواد بالذكاء الاصطناعي</h1>
            <p class="text-gray-400 mt-2">اختر مزود الخدمة، أدخل الكود والأوامر، ودع الذكاء الاصطناعي يعمل.</p>
        </header>

        <!-- API Provider Selection -->
        <div class="mb-4 bg-gray-800 p-4 rounded-lg border border-cyan-500/30 flex-shrink-0">
            <div class="flex items-center justify-center gap-6">
                <label class="radio-label flex items-center cursor-pointer">
                    <input type="radio" name="apiProvider" value="gemini" class="hidden" checked>
                    <span class="radio-button text-lg font-bold border-2 border-gray-600 rounded-lg px-6 py-2 transition-colors duration-200">Gemini</span>
                </label>
                <label class="radio-label flex items-center cursor-pointer">
                    <input type="radio" name="apiProvider" value="openai" class="hidden">
                    <span class="radio-button text-lg font-bold border-2 border-gray-600 rounded-lg px-6 py-2 transition-colors duration-200">OpenAI</span>
                </label>
            </div>
            <div class="mt-4">
                <label for="apiKeyInput" id="apiKeyLabel" class="block text-lg font-medium text-gray-200 mb-2">أدخل مفتاح Gemini API الخاص بك:</label>
                <div class="api-key-wrapper">
                    <input type="password" id="apiKeyInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-200 text-left" placeholder="الصق مفتاح Gemini هنا...">
                    <button id="verifyApiKeyButton" title="التحقق من المفتاح"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1-1-1-1 1H6.663a3.5 3.5 0 0 1-3.163 2zM2.5 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg></button>
                </div>
                <p id="apiKeyStatus" class="text-xs text-gray-400 mt-2 min-h-[16px]">اضغط على أيقونة المفتاح للتأكد من صلاحيته.</p>
            </div>
        </div>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-grow min-h-0">
            <!-- Input Section -->
            <div class="space-y-4 flex flex-col min-h-0">
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="label-with-action mb-2"><label class="block text-lg font-medium text-gray-300">1. الكود الكامل:</label><button class="paste-button" id="pasteCodeButton" title="لصق"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button></div>
                    <div class="editor-container"><textarea id="fullCode"></textarea></div>
                </div>
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="label-with-action mb-2"><label class="block text-lg font-medium text-gray-300">2. أوامر التعديل:</label><button class="paste-button" id="pasteCommandsButton" title="لصق"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button></div>
                    <div class="editor-container"><textarea id="commands"></textarea></div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="flex flex-col min-h-0">
                <div class="label-with-action mb-2"><h2 class="text-lg font-medium text-gray-300">3. الكود المُعدَّل:</h2><button id="copyButton" class="paste-button" title="نسخ"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg><span id="copyButtonText" class="hidden"></span></button></div>
                <div id="resultCodeWrapper" class="editor-container"></div>
            </div>
        </main>

        <!-- Action Buttons Area -->
        <div class="text-center pt-4 flex-shrink-0 flex justify-center items-center gap-4">
            <button id="processButton" class="action-button bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg transition duration-200 text-lg shadow-lg shadow-cyan-900/50 flex items-center justify-center">نفّذ التعديلات</button>
        </div>
        <div id="messageArea" class="mt-2 text-center text-sm min-h-[24px] transition-opacity duration-300 flex-shrink-0"></div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

    <script>
        // --- DOM Elements & Setup ---
        const dom = {
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeyLabel: document.getElementById('apiKeyLabel'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            verifyApiKeyButton: document.getElementById('verifyApiKeyButton'),
            processButton: document.getElementById('processButton'),
            copyButton: document.getElementById('copyButton'),
            messageArea: document.getElementById('messageArea'),
            pasteCodeButton: document.getElementById('pasteCodeButton'),
            pasteCommandsButton: document.getElementById('pasteCommandsButton'),
            apiProviderRadios: document.querySelectorAll('input[name="apiProvider"]'),
        };

        const editors = {
            fullCode: CodeMirror.fromTextArea(document.getElementById('fullCode'), { lineNumbers: true, mode: 'javascript', theme: 'dracula', lineWrapping: true }),
            commands: CodeMirror.fromTextArea(document.getElementById('commands'), { lineNumbers: true, theme: 'dracula', lineWrapping: true }),
            result: CodeMirror(document.getElementById('resultCodeWrapper'), { value: 'سيظهر الكود الناتج هنا...', lineNumbers: true, mode: 'javascript', theme: 'dracula', readOnly: true, lineWrapping: true })
        };
        
        // --- Event Listeners ---
        dom.verifyApiKeyButton.addEventListener('click', verifyApiKey);
        dom.processButton.addEventListener('click', applyEditsWithAI);
        dom.copyButton.addEventListener('click', copyResultToClipboard);
        dom.pasteCodeButton.addEventListener('click', () => pasteFromClipboard(editors.fullCode));
        dom.pasteCommandsButton.addEventListener('click', () => pasteFromClipboard(editors.commands));
        dom.apiProviderRadios.forEach(radio => radio.addEventListener('change', updateApiProviderUI));

        // --- Core Functions ---
        async function applyEditsWithAI() {
            if (!checkInputs()) return;
            setLoadingState(dom.processButton, true, 'جاري التنفيذ...');
            const systemPrompt = `You are an expert code editor AI. Apply the user's instructions to the source code. **IMPORTANT**: Your final output must be ONLY the complete, modified source code. Do not add explanations or markdown.`;
            const userPrompt = `Source Code:\n\`\`\`\n${editors.fullCode.getValue()}\n\`\`\`\n\nInstructions:\n---\n${editors.commands.getValue()}\n---`;
            try {
                const result = await callAIWithRetry(systemPrompt, userPrompt, false);
                editors.result.setValue(result.content.trim());
                showMessage(`تم تطبيق التعديلات بنجاح. (الاستهلاك: ${result.tokens} توكن)`, 'success');
            } catch (error) {
                showMessage(`فشل تطبيق التعديلات: ${error.message}`, 'error');
            } finally {
                setLoadingState(dom.processButton, false, 'نفّذ التعديلات');
            }
        }

        async function callAIWithRetry(systemPrompt, userPrompt, expectJson = true, retries = 3, delay = 2000) {
            const provider = getSelectedProvider();
            const apiKey = dom.apiKeyInput.value.trim();

            for (let i = 0; i < retries; i++) {
                try {
                    if (provider === 'gemini') {
                        return await callGemini(systemPrompt, userPrompt, apiKey, expectJson);
                    } else {
                        return await callOpenAI(systemPrompt, userPrompt, apiKey, expectJson);
                    }
                } catch (error) {
                    if (error.message.includes('429') && i < retries - 1) {
                        console.log(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                        showMessage(`تم تجاوز حد الطلبات. جاري إعادة المحاولة بعد ${delay / 1000} ثانية...`, 'info');
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error; // Re-throw other errors immediately
                    }
                }
            }
            throw new Error('فشل طلب الـ API بعد عدة محاولات.');
        }

        async function callGemini(systemPrompt, userPrompt, apiKey, expectJson) {
            const chatHistory = [{ role: "user", parts: [{ text: systemPrompt + "\n\n" + userPrompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`(Gemini) ${response.status}: ${errorData?.error?.message || 'خطأ غير معروف.'}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                let text = result.candidates[0].content.parts[0].text.replace(/^```(json|javascript|html|css)?\s*\n/i, '').replace(/\n```\s*$/, '');
                const tokens = result.usageMetadata?.totalTokenCount || 0;
                if (expectJson) {
                    try { return { content: JSON.parse(text), tokens: tokens }; } 
                    catch (e) { throw new Error(`فشل Gemini في إرجاع صيغة JSON صالحة. الاستجابة: ${text}`); }
                }
                return { content: text, tokens: tokens };
            } else {
                throw new Error(`فشل تحليل الاستجابة من Gemini. السبب: ${result.promptFeedback?.blockReason || 'استجابة فارغة.'}`);
            }
        }
        
        async function callOpenAI(systemPrompt, userPrompt, apiKey, expectJson) {
            const payload = { model: "gpt-4o", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }] };
            if (expectJson) { payload.response_format = { "type": "json_object" }; }
            const apiUrl = `https://api.openai.com/v1/chat/completions`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`(OpenAI) ${response.status}: ${errorData?.error?.message || 'خطأ غير معروف.'}`);
            }
            const result = await response.json();
            if (result.choices && result.choices[0].message && result.choices[0].message.content) {
                const text = result.choices[0].message.content;
                const tokens = result.usage?.total_tokens || 0;
                if (expectJson) {
                    try { return { content: JSON.parse(text), tokens: tokens }; } 
                    catch (e) { throw new Error(`فشل OpenAI في إرجاع صيغة JSON صالحة. الاستجابة: ${text}`); }
                }
                return { content: text, tokens: tokens };
            } else {
                 throw new Error(`فشل تحليل الاستجابة من OpenAI. السبب: ${result.choices[0].finish_reason || 'استجابة فارغة.'}`);
            }
        }

        // --- UI & Helper Functions ---
        function getSelectedProvider() { return document.querySelector('input[name="apiProvider"]:checked').value; }
        function updateApiProviderUI() {
            const provider = getSelectedProvider();
            dom.apiKeyLabel.textContent = provider === 'gemini' ? 'أدخل مفتاح Gemini API الخاص بك:' : 'أدخل مفتاح OpenAI API الخاص بك:';
            dom.apiKeyInput.placeholder = provider === 'gemini' ? 'الصق مفتاح Gemini هنا...' : 'الصق مفتاح OpenAI هنا...';
            dom.apiKeyStatus.textContent = 'اضغط على أيقونة المفتاح للتأكد من صلاحيته.';
            dom.apiKeyStatus.className = 'text-xs text-gray-400 mt-2 min-h-[16px]';
        }
        function checkInputs() {
            if (!dom.apiKeyInput.value.trim()) { showMessage('خطأ: الرجاء إدخال مفتاح API الخاص بك أولاً.', 'error'); dom.apiKeyInput.focus(); return false; }
            if (!editors.fullCode.getValue().trim()) { showMessage('خطأ: الرجاء إدخال الكود أولاً.', 'error'); return false; }
            if (!editors.commands.getValue().trim()) { showMessage('خطأ: الرجاء إدخال أوامر التعديل لتنفيذها.', 'error'); return false; }
            return true;
        }
        async function pasteFromClipboard(editorInstance) {
            try {
                const text = await navigator.clipboard.readText();
                editorInstance.setValue(text); showMessage('تم اللصق بنجاح.', 'success');
            } catch (err) { showMessage('فشل اللصق. تأكد من منح الإذن للوصول إلى الحافظة.', 'error'); }
        }
        function setLoadingState(button, isLoading, loadingText) {
            button.disabled = isLoading;
            const originalHTML = button.dataset.originalHTML || button.innerHTML;
            if (!button.dataset.originalHTML) button.dataset.originalHTML = originalHTML;
            button.innerHTML = isLoading ? `<svg class="animate-spin h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${loadingText}` : originalHTML;
        }
        async function verifyApiKey() {
            const provider = getSelectedProvider();
            const userApiKey = dom.apiKeyInput.value.trim();
            if (!userApiKey) { dom.apiKeyStatus.textContent = 'الرجاء إدخال مفتاح أولاً.'; dom.apiKeyStatus.className = 'text-xs text-red-400 mt-2 min-h-[16px]'; return; }
            dom.apiKeyStatus.textContent = 'جاري التحقق...';
            dom.apiKeyStatus.className = 'text-xs text-yellow-400 mt-2 min-h-[16px]';
            let apiUrl, options;
            if (provider === 'gemini') {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${userApiKey}`; options = {};
            } else {
                apiUrl = `https://api.openai.com/v1/models`; options = { headers: { 'Authorization': `Bearer ${userApiKey}` } };
            }
            try {
                const response = await fetch(apiUrl, options);
                if (response.ok) {
                    dom.apiKeyStatus.textContent = 'المفتاح صالح وجاهز للاستخدام.'; dom.apiKeyStatus.className = 'text-xs text-green-400 mt-2 min-h-[16px]';
                } else {
                    dom.apiKeyStatus.textContent = `المفتاح غير صالح (حالة: ${response.status}). تأكد من تفعيل الخدمة في حسابك.`; dom.apiKeyStatus.className = 'text-xs text-red-400 mt-2 min-h-[16px]';
                }
            } catch (error) {
                dom.apiKeyStatus.textContent = 'فشل التحقق. تأكد من اتصالك بالإنترنت.'; dom.apiKeyStatus.className = 'text-xs text-red-400 mt-2 min-h-[16px]';
            }
        }
        function copyResultToClipboard() { navigator.clipboard.writeText(editors.result.getValue()).then(() => { showMessage('تم نسخ الكود المُعدَّل بنجاح.', 'success'); }); }
        function showMessage(text, type) {
            const colorClasses = { success: 'text-green-400', error: 'text-red-400', info: 'text-blue-400' };
            dom.messageArea.textContent = text;
            dom.messageArea.className = `mt-2 text-center text-sm min-h-[24px] transition-opacity duration-300 ${colorClasses[type] || 'text-gray-400'}`;
        }
    </script>
</body>
</html>
